name: Copilot AI Review

"on":
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Collect changed files
        id: changed
        uses: tj-actions/changed-files@v44

      - name: Run Copilot review
        env:
          COPILOT_URL: ${{ secrets.COPILOT_URL }}
          COPILOT_API_KEY: ${{ secrets.COPILOT_API_KEY }}
        run: |
          # Validate secrets are configured
          if [ -z "$COPILOT_URL" ]; then
            echo "âš ï¸ COPILOT_URL secret not configured"
            echo "Configure it in: Settings â†’ Secrets and variables â†’ Actions â†’ Repository secrets"
            exit 1
          fi
          if [ -z "$COPILOT_API_KEY" ]; then
            echo "âš ï¸ COPILOT_API_KEY secret not configured"
            echo "Configure it in: Settings â†’ Secrets and variables â†’ Actions â†’ Repository secrets"
            exit 1
          fi

          # Process changed files
          echo "Processing changed files..."
          for file in ${{ steps.changed.outputs.all_changed_files }}; do
            # Skip non-code files
            if [[ $file =~ \.(md|json|yml|yaml|txt)$ ]]; then
              echo "Skipping documentation: $file"
              continue
            fi

            echo "Reviewing $file"
            content=$(cat "$file" | head -c 20000)
            curl -s -X POST "$COPILOT_URL/api/admin/copilot/" \
              -H "Content-Type: application/json" \
              -H "X-User-Id: github-actions" \
              -H "X-API-Key: $COPILOT_API_KEY" \
              -d "{\"message\": \"Review this file and suggest improvements:\n$file\n\n$content\"}" \
              > "copilot_review_${file//\//_}.json" || echo "Failed to review $file"
          done

      - name: Post review summary
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find all review files
            const files = fs.readdirSync('.').filter(f => f.startsWith('copilot_review_'));
            if (!files.length) {
              console.log('No review files generated');
              return;
            }

            let body = '## ðŸ¤– Copilot AI Review Summary\n\n';
            let reviewCount = 0;

            for (const file of files) {
              try {
                const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                if (data.response || data.message) {
                  const originalFile = file.replace('copilot_review_', '').replace('.json', '').replace(/_/g, '/');
                  body += `### ${originalFile}\n`;
                  body += (data.response || data.message) + '\n\n';
                  reviewCount++;
                }
              } catch (e) {
                console.error(`Failed to parse ${file}`);
              }
            }

            if (reviewCount === 0) {
              body += 'No reviews generated.\n';
            } else {
              body += `**Total files reviewed:** ${reviewCount}\n`;
            }

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
              console.log('Review summary posted');
            } catch (e) {
              console.error('Failed to post comment:', e);
            }
