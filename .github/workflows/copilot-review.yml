name: Copilot AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Collect changed files
        id: changed
        uses: tj-actions/changed-files@v44

      - name: Run Copilot review
        env:
          COPILOT_URL: ${{ secrets.COPILOT_URL }}
          COPILOT_API_KEY: ${{ secrets.COPILOT_API_KEY }}
        run: |
          if [ -z "$COPILOT_URL" ]; then
            echo "COPILOT_URL is not set" && exit 1
          fi
          if [ -z "$COPILOT_API_KEY" ]; then
            echo "COPILOT_API_KEY is not set" && exit 1
          fi

          for file in ${{ steps.changed.outputs.all_changed_files }}; do
            echo "Reviewing $file"
            content=$(cat "$file" | head -c 20000)
            curl -s -X POST "$COPILOT_URL/api/admin/copilot/" \
              -H "Content-Type: application/json" \
              -H "X-User-Id: github-actions" \
              -H "X-API-Key: $COPILOT_API_KEY" \
              -d "{\"message\": \"Review this file and suggest improvements:\n$file\n\n$content\"}" \
              > "copilot_review_${file//\//_}.json"
          done

      - name: Post review summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const files = fs.readdirSync('.').filter(f => f.startsWith('copilot_review_'));
            if (!files.length) return;
            let body = '## Copilot Review Summary\n\n';
            for (const file of files) {
              const data = JSON.parse(fs.readFileSync(file, 'utf8'));
              body += `### ${file}\n`;
              body += (data.response || 'No response') + '\n\n';
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
